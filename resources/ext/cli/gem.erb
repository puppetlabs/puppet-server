#!/usr/bin/env bash
PATH=/opt/puppet/bin:$PATH

function parse_config_file() {
    VALUE=$(puppet config print --section user $1)
    if [ "$VALUE" == "none" ] ; then
        # remove any 'none' values
        VALUE=""
    fi
    echo $VALUE
}

if [ ! -n "$http_proxy" ] ; then
    HTTP_PROXY_HOST=$(parse_config_file http_proxy_host)
    HTTP_PROXY_PORT=$(parse_config_file http_proxy_port)
    HTTP_PROXY_USER=$(parse_config_file http_proxy_user)
    HTTP_PROXY_PASSWORD=$(parse_config_file http_proxy_password)
    SOURCE="$(puppet config print confdir)/puppet.conf"
    if [ -n "$HTTP_PROXY_HOST" ] && [ -n "$HTTP_PROXY_PORT" ] ; then
        export http_proxy="http://${HTTP_PROXY_USER}:${HTTP_PROXY_PASSWORD}@${HTTP_PROXY_HOST}:${HTTP_PROXY_PORT}"
    fi
fi

"${JAVA_BIN}" -cp "${INSTALL_DIR}/<%= EZBake::Config[:uberjar_name] %>" \
    clojure.main -m puppetlabs.puppetserver.cli.gem \
    --config "${CONFIG}" -- "$@"
